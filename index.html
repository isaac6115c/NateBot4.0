<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NateBot 4.0</title>
  <link rel="stylesheet" href="css/chessboard.css">
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/chessboard.js"></script>
  <script src="js/chess-0.10.2.min.js"></script>
  <script src="js/stockfish.js"></script>
  <style>
    body { background:#1c1c1c; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; display:flex; flex-direction:column; align-items:center; padding:20px; overflow:hidden }
    h1 { margin:0 0 10px }
    #menu { background:#2a2a2a; padding:16px; border-radius:10px; width:480px; max-width:95vw }
    #menu h2 { margin:0 0 8px; font-size:18px }
    #menu select, #menu button { width:100%; padding:10px; margin:8px 0; font-size:16px; border-radius:8px; border:1px solid #444; background:#1f1f1f; color:#fff }
    #gameArea { display:flex; flex-direction:row; gap:20px; margin-top:18px; }
    #board { width:480px; max-width:95vw; }
    #controls { display:none; margin-top:12px; width:480px; max-width:95vw }
    #controls button { width:100%; padding:10px; font-size:16px; border-radius:8px; border:1px solid #444; background:#1f1f1f; color:#fff }
    #moveList { width:200px; max-height:500px; overflow-y:auto; background:#2a2a2a; padding:10px; border-radius:8px; font-size:14px; }
    #moveList h3 { margin-top:0; font-size:16px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:center; padding:4px; border-bottom:1px solid #444; }
    .highlight { box-shadow: inset 0 0 0 3px red !important }
    #status { margin-top:12px; font-size:18px; font-weight:bold; color:#f59e0b; display:none; text-align:center; }
    #newGameBtn { margin-top:12px; padding:10px; font-size:16px; border-radius:8px; border:1px solid #444; background:#f59e0b; color:#000; display:none; cursor:pointer; }
    .emoji { position:fixed; font-size:2rem; pointer-events:none; animation: fall 3s linear forwards; }
    @keyframes fall {
      from { transform: translateY(-50px) rotate(0deg); opacity:1; }
      to { transform: translateY(100vh) rotate(720deg); opacity:0; }
    }
  </style>
</head>
<body>
  <h1>NateBot 4.0</h1>

  <div id="menu">
    <h2>Choose Your Side</h2>
    <select id="colorSelect">
      <option value="white">Play as White</option>
      <option value="black">Play as Black</option>
    </select>

    <h2>Choose NateBotâ€™s Opening</h2>
    <select id="openingSelect"></select>

    <button id="startBtn">Start Game</button>
  </div>

  <div id="gameArea" style="display:none;">
    <div>
      <div id="board"></div>
      <div id="status"></div>
      <button id="newGameBtn">Start New Game</button>
    </div>
    <div id="moveList">
      <h3>Moves</h3>
      <table id="movesTable">
        <thead><tr><th>#</th><th>White</th><th>Black</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="controls">
    <button id="weedBtn">Weed Them Out</button>
  </div>

  <script>
    let board, game, stockfish
    let playerColor = "white"
    let aiColor = "black"
    let openingPlayed = false
    let selectedOpening = "bird"

    const openings = {
      white: [
        { value:"bird", text:"Birdâ€™s Opening (f4)" },
        { value:"bongcloud", text:"Bongcloud (e4)" },
        { value:"monkey", text:"Monkeyâ€™s Bum (e4)" }
      ],
      black: [
        { value:"grob", text:"Grob Attack (g5)" },
        { value:"bongcloud", text:"Bongcloud (e5)" },
        { value:"monkey", text:"Monkeyâ€™s Bum (e5)" }
      ]
    }

    function pieceTheme(piece) {
      if (piece === "wK" && aiColor === "white") return "pieces/wKn.png"
      if (piece === "bK" && aiColor === "black") return "pieces/bKn.png"
      return "pieces/" + piece + ".png"
    }

    function populateOpenings() {
      const sel = document.getElementById("openingSelect")
      sel.innerHTML = ""
      openings[aiColor].forEach(o => {
        const opt = document.createElement("option")
        opt.value = o.value
        opt.textContent = o.text
        sel.appendChild(opt)
      })
      selectedOpening = sel.value
    }

    function initStockfish() {
      stockfish = new Worker("js/stockfish.js")
      stockfish.postMessage("uci")
      stockfish.postMessage("setoption name UCI_LimitStrength value true")
      stockfish.postMessage("setoption name UCI_Elo value 2400")
      stockfish.postMessage("setoption name Skill Level value 20")
      stockfish.postMessage("isready")
      stockfish.onmessage = function(e) {
        const line = e.data || ""
        if (line.startsWith("bestmove")) {
          const parts = line.split(" ")
          const mv = parts[1]
          if (mv && mv !== "(none)") {
            game.move({ from: mv.slice(0,2), to: mv.slice(2,4), promotion:"q" })
            board.position(game.fen())
            updateMoveList()
            checkGameOver()
            openingPlayed = true
          }
        }
      }
    }

    function engineMove() {
      if (game.game_over()) return
      if ((aiColor === "white" && game.turn() !== "w") || (aiColor === "black" && game.turn() !== "b")) return
      stockfish.postMessage("position fen " + game.fen())
      stockfish.postMessage("go movetime 600")
    }

    function playOpeningOnce() {
      if (openingPlayed) return
      const map = {
        bird:   { white:"f2f4" },
        grob:   { black:"g7g5" },
        bongcloud: { white:"e2e4", black:"e7e5" },
        monkey:    { white:"e2e4", black:"e7e5" }
      }
      const m = (map[selectedOpening] || {})[aiColor]
      if (m) {
        game.move({ from:m.slice(0,2), to:m.slice(2,4), promotion:"q" })
        board.position(game.fen())
        updateMoveList()
        checkGameOver()
      }
      openingPlayed = true
      setTimeout(engineMove, 250)
    }

    function clearHighlights() {
      $("#board .square-55d63").removeClass("highlight")
    }

    function highlightMove(move) {
      clearHighlights()
      const a = ".square-" + move.from
      const b = ".square-" + move.to
      $(a).addClass("highlight")
      $(b).addClass("highlight")
      setTimeout(clearHighlights, 1200)
    }

    function suggestWorstAndHighlight() {
      if (game.game_over()) return
      const legal = game.moves({ verbose:true })
      if (!legal.length) return
      const mv = legal[legal.length - 1]
      highlightMove(mv)
    }

    function onDragStart(source, piece) {
      if (game.game_over()) return false
      if ((piece.startsWith("w") && aiColor === "white") || (piece.startsWith("b") && aiColor === "black")) return false
      if ((playerColor === "white" && piece.startsWith("b")) || (playerColor === "black" && piece.startsWith("w"))) return false
    }

    function onDrop(source, target) {
      const move = game.move({ from:source, to:target, promotion:"q" })
      if (move === null) return "snapback"
      board.position(game.fen())
      updateMoveList()
      checkGameOver()
      if (!openingPlayed && aiColor === "black") {
        setTimeout(playOpeningOnce, 250)
      } else {
        setTimeout(engineMove, 250)
      }
    }

    function updateMoveList() {
      const history = game.history()
      const tbody = document.querySelector("#movesTable tbody")
      tbody.innerHTML = ""
      for (let i = 0; i < history.length; i += 2) {
        const moveNum = (i/2)+1
        const white = history[i] || ""
        const black = history[i+1] || ""
        const row = `<tr><td>${moveNum}</td><td>${white}</td><td>${black}</td></tr>`
        tbody.innerHTML += row
      }
    }

    function checkGameOver() {
      if (game.in_checkmate()) {
        if (game.turn() === "w") {
          showStatus("NateBot Wins by Checkmate!")
          launchEmojiStorm("ðŸ¤°")
        } else {
          showStatus("You Win by Checkmate!")
        }
        document.getElementById("newGameBtn").style.display = "block"
      }
    }

    function showStatus(msg) {
      const statusDiv = document.getElementById("status")
      statusDiv.textContent = msg
      statusDiv.style.display = "block"
    }

    function launchEmojiStorm(emoji) {
      for (let i = 0; i < 60; i++) {
        const span = document.createElement("span")
        span.className = "emoji"
        span.textContent = emoji
        span.style.left = Math.random() * 100 + "vw"
        span.style.top = "-50px"
        span.style.animationDuration = (2 + Math.random() * 2) + "s"
        document.body.appendChild(span)
        setTimeout(() => span.remove(), 4000)
      }
    }

    function resetGame() {
      document.getElementById("menu").style.display = "block"
      document.getElementById("gameArea").style.display = "none"
      document.getElementById("controls").style.display = "none"
      document.getElementById("status").style.display = "none"
      document.getElementById("newGameBtn").style.display = "none"
      const tbody = document.querySelector("#movesTable tbody")
      tbody.innerHTML = ""
    }

    document.getElementById("newGameBtn").addEventListener("click", resetGame)

    document.getElementById("colorSelect").addEventListener("change", function() {
      playerColor = this.value
      aiColor = playerColor === "white" ? "black" : "white"
      populateOpenings()
    })

    document.getElementById("openingSelect").addEventListener("change", function() {
      selectedOpening = this.value
    })

    document.getElementById("startBtn").addEventListener("click", function() {
      playerColor = document.getElementById("colorSelect").value
      aiColor = playerColor === "white" ? "black" : "white"
      selectedOpening = document.getElementById("openingSelect").value
      document.getElementById("menu").style.display = "none"
      document.getElementById("gameArea").style.display = "flex"
      document.getElementById("controls").style.display = "block"
      document.getElementById("status").style.display = "none"
      document.getElementById("newGameBtn").style.display = "none"
      openingPlayed = false
      game = new Chess()
      board = ChessBoard("board", {
        orientation: playerColor,
        position: "start",
        draggable: true,
        pieceTheme: pieceTheme,
        onDragStart: onDragStart,
        onDrop: onDrop
      })
      updateMoveList()
      initStockfish()
      if (aiColor === "white") setTimeout(playOpeningOnce, 400)
    })

    document.getElementById("weedBtn").addEventListener("click", suggestWorstAndHighlight)

    populateOpenings()
  </script>
</body>
</html>
